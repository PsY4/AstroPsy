{% extends 'base.html.twig' %}
{% set pageTitle = 'Switch Setup' %}
{% set previousCrumb %}
    <li><a class="f-s-14 f-w-500" href="{{ path('alpaca_setup_index') }}">Alpaca</a></li>
{% endset %}

{% block body %}

{% if data.error is defined %}
<div class="alert alert-danger">
    <i class="fa fa-triangle-exclamation"></i>
    {{ 'alpaca.safetymonitor_setup.server_unreachable'|trans }} <strong>{{ data.error }}</strong>
</div>
{% else %}

{% set items = data.items %}

{# â”€â”€ Edit / Delete existing items â”€â”€ #}
<div class="card mb-4">
    <div class="card-header d-flex align-items-center">
        <strong>{{ 'alpaca.switch_setup.title'|trans }}</strong>
        <span class="badge bg-secondary ms-2">{{ items|length }}</span>
        <small class="text-muted ms-3">{{ 'alpaca.switch_setup.hint'|trans|raw }}</small>
    </div>
    <div class="card-body p-0">
        <form method="POST">
            <input type="hidden" name="action" value="save">

            {% if items %}
            <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:40px" class="text-center">{{ 'alpaca.switch_setup.col_id'|trans }}</th>
                        <th style="width:80px">{{ 'alpaca.switch_setup.col_type'|trans }}</th>
                        <th>{{ 'alpaca.switch_setup.col_name'|trans }}</th>
                        <th>{{ 'alpaca.switch_setup.col_description'|trans }}</th>
                        <th style="width:110px">{{ 'alpaca.switch_setup.col_value'|trans }}</th>
                        <th style="width:90px">{{ 'alpaca.switch_setup.col_min'|trans }}</th>
                        <th style="width:90px">{{ 'alpaca.switch_setup.col_max'|trans }}</th>
                        <th style="width:90px">{{ 'alpaca.switch_setup.col_step'|trans }}</th>
                        <th style="width:50px" class="text-center">ðŸ—‘</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in items %}
                <tr id="row_{{ item.id }}">
                    <td class="text-center text-muted">{{ item.id }}</td>
                    <td>
                        {% if item.is_boolean %}
                            <span class="badge bg-primary">{{ 'alpaca.switch_setup.type_switch'|trans }}</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">{{ 'alpaca.switch_setup.type_gauge'|trans }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <input class="form-control form-control-sm"
                               type="text" name="name_{{ item.id }}" value="{{ item.name }}">
                    </td>
                    <td>
                        <input class="form-control form-control-sm"
                               type="text" name="desc_{{ item.id }}" value="{{ item.description }}">
                    </td>
                    <td>
                        {% if item.is_boolean %}
                            <input class="form-check-input" type="checkbox"
                                   name="value_{{ item.id }}" value="{{ item.value }}"
                                   {% if item.value != 0.0 %}checked{% endif %}>
                        {% else %}
                            <input class="form-control form-control-sm" type="number"
                                   name="value_{{ item.id }}" value="{{ item.value }}"
                                   min="{{ item.min_value }}" max="{{ item.max_value }}" step="{{ item.step }}">
                        {% endif %}
                    </td>
                    <td>
                        {% if not item.is_boolean %}
                            <input class="form-control form-control-sm" type="number"
                                   name="min_{{ item.id }}" value="{{ item.min_value }}" step="any">
                        {% else %}<span class="text-muted">â€”</span>{% endif %}
                    </td>
                    <td>
                        {% if not item.is_boolean %}
                            <input class="form-control form-control-sm" type="number"
                                   name="max_{{ item.id }}" value="{{ item.max_value }}" step="any">
                        {% else %}<span class="text-muted">â€”</span>{% endif %}
                    </td>
                    <td>
                        {% if not item.is_boolean %}
                            <input class="form-control form-control-sm" type="number"
                                   name="step_{{ item.id }}" value="{{ item.step }}" step="any">
                        {% else %}<span class="text-muted">â€”</span>{% endif %}
                    </td>
                    <td class="text-center">
                        <input class="form-check-input del-cb" type="checkbox"
                               name="delete_{{ item.id }}" value="1"
                               title="Supprimer" onchange="markDelete(this, {{ item.id }})">
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
            {% else %}
            <p class="text-muted fst-italic p-3 mb-0">{{ 'alpaca.switch_setup.no_items'|trans }}</p>
            {% endif %}

            <div class="p-3 border-top">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fa fa-fw fa-floppy-disk"></i> {{ 'alpaca.switch_setup.btn_save'|trans }}
                </button>
            </div>
        </form>
    </div>
</div>

{# â”€â”€ Add new item â”€â”€ #}
<div class="card">
    <div class="card-header"><strong>{{ 'alpaca.switch_setup.btn_add'|trans }}</strong></div>
    <div class="card-body">
        <form method="POST">
            <input type="hidden" name="action" value="add">
            <div class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_type'|trans }}</label>
                    <select class="form-select form-select-sm" name="new_type" id="new_type"
                            onchange="toggleGaugeFields()">
                        <option value="switch">{{ 'alpaca.switch_setup.add_form.option_switch'|trans }}</option>
                        <option value="gauge">{{ 'alpaca.switch_setup.add_form.option_gauge'|trans }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_name'|trans }}</label>
                    <input class="form-control form-control-sm" type="text" name="new_name"
                           placeholder="{{ 'alpaca.switch_setup.add_form.placeholder_name'|trans }}">
                </div>
                <div class="col">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_description'|trans }}</label>
                    <input class="form-control form-control-sm" type="text" name="new_desc" placeholder="">
                </div>
            </div>
            <div class="row g-3 align-items-end mt-1" id="gauge_fields" style="display:none !important">
                <div class="col-auto">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_min'|trans }}</label>
                    <input class="form-control form-control-sm" type="number" name="new_min" value="0" step="any" style="width:90px">
                </div>
                <div class="col-auto">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_max'|trans }}</label>
                    <input class="form-control form-control-sm" type="number" name="new_max" value="100" step="any" style="width:90px">
                </div>
                <div class="col-auto">
                    <label class="form-label">{{ 'alpaca.switch_setup.add_form.label_step'|trans }}</label>
                    <input class="form-control form-control-sm" type="number" name="new_step" value="0.1" step="any" style="width:90px">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fa fa-fw fa-plus"></i> {{ 'alpaca.switch_setup.add_form.btn_submit'|trans }}
                </button>
            </div>
        </form>
    </div>
</div>

{% endif %}
{% endblock %}

{% block page_scripts %}
<script>
function toggleGaugeFields() {
    var t = document.getElementById('new_type').value;
    var el = document.getElementById('gauge_fields');
    el.style.setProperty('display', t === 'gauge' ? 'flex' : 'none', 'important');
}
function markDelete(cb, rowId) {
    var row = document.getElementById('row_' + rowId);
    if (row) row.classList.toggle('table-danger', cb.checked);
}
</script>
{% endblock %}

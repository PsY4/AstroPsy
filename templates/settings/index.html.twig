{% set pageTitle = 'settings.title'|trans %}
{% extends 'base.html.twig' %}

{% block body %}

<div class="row">

    {# ============================================================
       SECTION : Language / Langue
    ============================================================ #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-language text-primary"></i>
                <h5 class="mb-0">{{ 'settings.language.title'|trans }}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">{{ 'settings.language.help'|trans }}</p>
                <div class="d-flex gap-2">
                    <form method="post" action="{{ path('settings_locale', {locale: 'fr'}) }}">
                        <button type="submit"
                                class="btn {% if app.request.locale == 'fr' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            Fran&ccedil;ais
                        </button>
                    </form>
                    <form method="post" action="{{ path('settings_locale', {locale: 'en'}) }}">
                        <button type="submit"
                                class="btn {% if app.request.locale == 'en' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                            English
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# ============================================================
       SECTION : OpenFolder Protocol
    ============================================================ #}
    <div class="col-lg-6" id="openfolder">
        <div class="card mb-4" id="openfolder-card">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-folder-open text-primary"></i>
                <h5 class="mb-0">{{ 'settings.openfolder.title'|trans }}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">{{ 'settings.openfolder.description'|trans }}</p>

                {# Installation guide — hidden when ack'd #}
                <div id="openfolder-setup">
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="fa fa-triangle-exclamation me-1"></i>
                        <strong>{{ 'settings.openfolder.not_installed_title'|trans }}</strong>
                        <div class="mt-1 small">{{ 'settings.openfolder.not_installed_body'|trans }}</div>
                    </div>

                    <ol class="small mb-3">
                        <li>{{ 'settings.openfolder.step1'|trans }}
                            <a href="{{ path('openfolder_download') }}" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fa fa-download me-1"></i>{{ 'settings.openfolder.btn_download'|trans }}
                            </a>
                        </li>
                        <li class="mt-2">{{ 'settings.openfolder.step2'|trans }}</li>
                        <li class="mt-1">{{ 'settings.openfolder.step3'|trans }}</li>
                        <li class="mt-1">{{ 'settings.openfolder.step4'|trans }}</li>
                    </ol>
                </div>

                {# Success state — shown when ack'd #}
                <div id="openfolder-done" class="d-none">
                    <div class="alert alert-success py-2 mb-3">
                        <i class="fa fa-check-circle me-1"></i>
                        {{ 'settings.openfolder.ack_done'|trans }}
                    </div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                    <a href="openfolder:/" class="btn btn-sm btn-outline-info">
                        <i class="fa fa-play me-1"></i>{{ 'settings.openfolder.btn_test'|trans }}
                    </a>
                    <span class="text-muted small">{{ 'settings.openfolder.test_help'|trans }}</span>
                </div>
                <div class="mt-2" id="openfolder-ack-wrapper">
                    <button type="button" id="openfolder-ack-btn" class="btn btn-sm btn-success">
                        <i class="fa fa-check me-1"></i>{{ 'settings.openfolder.btn_ack'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# ============================================================
       SECTION : Notifications & Alertes
    ============================================================ #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-bell text-primary"></i>
                <h5 class="mb-0">{{ 'settings.notifications.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'notifications'}) }}">
                <div class="card-body">

                    {# Emails #}
                    <div class="mb-4">
                        <label class="form-label fw-medium">
                            <i class="fa fa-fw fa-envelope"></i>
                            {{ 'settings.notifications.emails'|trans }}
                        </label>
                        <textarea name="emails" class="form-control font-monospace" rows="3"
                                  placeholder="une@adresse.com&#10;autre@adresse.com">{{ notifications.emails|join('\n') }}</textarea>
                        <div class="form-text">{{ 'settings.notifications.emails_help'|trans }}</div>
                    </div>

                    <hr>

                    {# Seuils météo #}
                    <p class="fw-medium mb-3">
                        <i class="fa fa-fw fa-cloud"></i>
                        {{ 'settings.notifications.weather_thresholds'|trans }}
                    </p>

                    <div class="row g-3 mb-3">
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.cloud_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_cloud_max" class="form-control"
                                       value="{{ notifications.weather_cloud_max }}" min="0" max="100" step="5">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.wind_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_wind_max" class="form-control"
                                       value="{{ notifications.weather_wind_max }}" min="0" max="30" step="0.5">
                                <span class="input-group-text">m/s</span>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.precip_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_precip_max" class="form-control"
                                       value="{{ notifications.weather_precip_max }}" min="0" max="10" step="0.1">
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    {# Seuils astronomiques #}
                    <p class="fw-medium mb-3">
                        <i class="fa fa-fw fa-moon"></i>
                        {{ 'settings.notifications.astro_thresholds'|trans }}
                    </p>

                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label small">{{ 'settings.notifications.min_useful_hours'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="min_useful_hours" class="form-control"
                                       value="{{ notifications.min_useful_hours }}" min="0" max="12" step="0.5">
                                <span class="input-group-text">h</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label small">{{ 'settings.notifications.min_moon_sep'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="min_moon_sep" class="form-control"
                                       value="{{ notifications.min_moon_sep }}" min="0" max="180" step="5">
                                <span class="input-group-text">°</span>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-footer text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# ============================================================
       SECTION : Filtres
    ============================================================ #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-filter text-primary"></i>
                <h5 class="mb-0">{{ 'settings.filters.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'filters'}) }}">
                <div class="card-body p-2">
                    <p class="text-muted small mb-2">{{ 'settings.filters.aliases_help'|trans }}</p>
                    <table id="filters-table" class="table table-sm align-middle mb-2">
                        <thead>
                            <tr>
                                <th style="width:44px">{{ 'settings.filters.color'|trans }}</th>
                                <th style="width:90px">{{ 'settings.filters.label'|trans }}</th>
                                <th style="width:80px">{{ 'settings.filters.band'|trans }}</th>
                                <th>{{ 'settings.filters.aliases'|trans }}</th>
                                <th style="width:36px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in filters %}
                            <tr>
                                <td><input type="color" name="filter_color[]" class="form-control form-control-color p-0 border-0" value="{{ f.color }}" style="width:36px;height:32px;cursor:pointer"></td>
                                <td><input name="filter_label[]" class="form-control form-control-sm" value="{{ f.label }}"></td>
                                <td>
                                    <select name="filter_band[]" class="form-select form-select-sm">
                                        <option value="BB" {% if (f.band|default('BB')) == 'BB' %}selected{% endif %}>BB</option>
                                        <option value="NB" {% if (f.band|default('BB')) == 'NB' %}selected{% endif %}>NB</option>
                                    </select>
                                </td>
                                <td><input name="filter_aliases[]" class="form-control form-control-sm" value="{{ f.aliases|join(', ') }}" placeholder="lum, luminance, …"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-filter-row">✕</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" id="add-filter-row" class="btn btn-sm btn-outline-secondary">
                        <i class="fa fa-plus me-1"></i>{{ 'settings.filters.add'|trans }}
                    </button>
                </div>
                <div class="card-footer text-end py-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# ============================================================
       SECTION : Session Folder Template
    ============================================================ #}
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-folder-tree text-primary"></i>
                <h5 class="mb-0">{{ 'settings.template.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'session_template'}) }}">
                <div class="card-body">
                    <p class="text-muted small mb-2">{{ 'settings.template.help'|trans }}</p>

                    <div id="template-roles-status" class="alert alert-success py-1 px-2 small mb-3"></div>

                    <div id="template-editor"
                         data-roles='{{ roles|json_encode }}'
                         data-default-template='{{ template_tree|json_encode }}'
                         data-msg-valid="{{ 'settings.template.roles_valid'|trans }}"
                         data-msg-missing="{{ 'settings.template.roles_missing'|trans }}"
                         data-msg-duplicate="{{ 'settings.template.roles_duplicate'|trans }}"
                         data-msg-allow-extra="{{ 'settings.template.allow_extra'|trans }}"
                         data-msg-folder-name="{{ 'settings.template.folder_name'|trans }}"
                         data-msg-add-child="{{ 'settings.template.add_child'|trans }}"
                         data-msg-remove="{{ 'settings.template.remove'|trans }}">
                    </div>

                    <input type="hidden" name="session_template" id="template-json"
                           value='{{ template_tree|json_encode }}'>

                    <div class="mt-3 d-flex gap-2 align-items-center">
                        <button type="button" id="template-add-root" class="btn btn-sm btn-outline-secondary">
                            <i class="fa fa-plus me-1"></i>{{ 'settings.template.add_root'|trans }}
                        </button>
                        <button type="button" id="template-reset" class="btn btn-sm btn-outline-warning">
                            <i class="fa fa-rotate-left me-1"></i>{{ 'settings.template.reset'|trans }}
                        </button>
                    </div>

                    <hr class="my-3">

                    <div class="template-danger-zone">
                        <p class="small fw-medium mb-2">
                            <i class="fa fa-fw fa-triangle-exclamation text-danger"></i>
                            {{ 'settings.template.migrate_zone'|trans }}
                        </p>
                        <div class="d-flex gap-2">
                            <button type="button" id="template-dry-run" class="btn btn-sm btn-outline-info">
                                <i class="fa fa-eye me-1"></i>{{ 'settings.template.dry_run_btn'|trans }}
                            </button>
                            <button type="button" id="template-migrate" class="btn btn-sm btn-outline-danger">
                                <i class="fa fa-arrows-rotate me-1"></i>{{ 'settings.template.migrate_btn'|trans }}
                            </button>
                        </div>
                        <div id="template-dry-run-result" class="mt-2 d-none"></div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button type="submit" id="template-save-btn" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

<script>
(function () {
    var setup = document.getElementById('openfolder-setup');
    var done = document.getElementById('openfolder-done');
    var ackWrapper = document.getElementById('openfolder-ack-wrapper');
    var ackBtn = document.getElementById('openfolder-ack-btn');

    function updateState() {
        if (localStorage.getItem('openfolder_installed') === '1') {
            setup.classList.add('d-none');
            done.classList.remove('d-none');
            ackWrapper.classList.add('d-none');
        } else {
            setup.classList.remove('d-none');
            done.classList.add('d-none');
            ackWrapper.classList.remove('d-none');
        }
    }

    ackBtn.addEventListener('click', function () {
        localStorage.setItem('openfolder_installed', '1');
        updateState();
    });

    // Allow re-showing setup by clicking the success alert
    done.addEventListener('click', function () {
        localStorage.removeItem('openfolder_installed');
        updateState();
    });

    updateState();
})();
</script>
<script>
(function () {
    const tmpl = `<tr>
  <td><input type="color" name="filter_color[]" class="form-control form-control-color p-0 border-0" value="#6c757d" style="width:36px;height:32px;cursor:pointer"></td>
  <td><input name="filter_label[]" class="form-control form-control-sm"></td>
  <td><select name="filter_band[]" class="form-select form-select-sm"><option value="BB" selected>BB</option><option value="NB">NB</option></select></td>
  <td><input name="filter_aliases[]" class="form-control form-control-sm" placeholder="lum, luminance, …"></td>
  <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-filter-row">✕</button></td>
</tr>`;
    document.getElementById('add-filter-row').addEventListener('click', () => {
        document.querySelector('#filters-table tbody').insertAdjacentHTML('beforeend', tmpl);
    });
    document.getElementById('filters-table').addEventListener('click', (e) => {
        if (e.target.classList.contains('js-remove-filter-row')) {
            e.target.closest('tr').remove();
        }
    });
})();
</script>
<script src="{{ asset('assets/js/session-template-editor.js') }}?v=2"></script>
<script>
(function () {
    var dryRunBtn = document.getElementById('template-dry-run');
    var migrateBtn = document.getElementById('template-migrate');
    var resultDiv = document.getElementById('template-dry-run-result');

    if (dryRunBtn) {
        dryRunBtn.addEventListener('click', function () {
            dryRunBtn.disabled = true;
            fetch('{{ path('settings_template_dry_run') }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    resultDiv.classList.remove('d-none');
                    if (data.total_moves === 0) {
                        resultDiv.className = 'mt-2 alert alert-info py-2 small';
                        resultDiv.textContent = '{{ 'settings.template.dry_run_no_changes'|trans|e('js') }}';
                    } else {
                        var html = '<strong>' + data.affected + ' {{ 'settings.template.dry_run_sessions_affected'|trans|e('js') }}, ' + data.total_moves + ' {{ 'settings.template.dry_run_file_moves'|trans|e('js') }}</strong>';
                        html += '<ul class="mb-0 mt-1">';
                        data.details.forEach(function (d) {
                            html += '<li>' + d.session;
                            d.moves.forEach(function (m) {
                                html += '<br><small class="text-muted">' + m.role + ': ' + m.from + ' &rarr; ' + m.to + ' (' + m.files + ' files)</small>';
                            });
                            html += '</li>';
                        });
                        html += '</ul>';
                        resultDiv.className = 'mt-2 alert alert-warning py-2 small';
                        resultDiv.innerHTML = html;
                    }
                    dryRunBtn.disabled = false;
                })
                .catch(function () { dryRunBtn.disabled = false; });
        });
    }

    if (migrateBtn) {
        migrateBtn.addEventListener('click', function () {
            if (!confirm('{{ 'settings.template.migrate_confirm'|trans }}')) return;
            migrateBtn.disabled = true;
            fetch('{{ path('settings_template_migrate') }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.dispatched) {
                        resultDiv.classList.remove('d-none');
                        resultDiv.className = 'mt-2 alert alert-success py-2 small';
                        resultDiv.textContent = '{{ 'settings.template.migrate_dispatched'|trans }}';
                    }
                    migrateBtn.disabled = false;
                })
                .catch(function () { migrateBtn.disabled = false; });
        });
    }
})();
</script>

</div>
{% endblock %}

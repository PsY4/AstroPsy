{% set pageTitle = 'settings.title'|trans %}
{% extends 'base.html.twig' %}

{% block body %}

<div class="row">

    {# ============================================================
       SECTION : Dossier racine des sessions
    ============================================================ #}
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-hard-drive text-primary"></i>
                <h5 class="mb-0">{{ 'settings.sessions_root.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'sessions_root'}) }}">
                <div class="card-body">
                    <p class="text-muted small mb-3">{{ 'settings.sessions_root.help'|trans }}</p>

                    <div class="d-flex align-items-center gap-2 mb-3">
                        <label class="form-label fw-medium mb-0">{{ 'settings.sessions_root.current_path'|trans }}</label>
                        {% if sessions_root_is_custom %}
                            <span class="badge bg-info">{{ 'settings.sessions_root.using_custom'|trans }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ 'settings.sessions_root.using_env'|trans }}</span>
                        {% endif %}
                    </div>

                    <div class="input-group mb-3">
                        <input type="text" name="sessions_root" id="sessions-root-input"
                               class="form-control font-monospace" value="{{ sessions_root }}" readonly>
                        <button type="button" id="sessions-root-browse" class="btn btn-outline-secondary">
                            <i class="fa fa-folder-open me-1"></i>{{ 'settings.sessions_root.browse'|trans }}
                        </button>
                        <button type="button" id="sessions-root-reset" class="btn btn-outline-warning">
                            <i class="fa fa-rotate-left me-1"></i>{{ 'settings.sessions_root.reset_env'|trans }}
                        </button>
                    </div>

                    <div id="sessions-root-browser" class="d-none border rounded p-2 mb-3">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <button type="button" id="sessions-root-go-up" class="btn btn-sm btn-outline-secondary">
                                <i class="fa fa-arrow-up me-1"></i>{{ 'settings.sessions_root.go_up'|trans }}
                            </button>
                            <span id="sessions-root-current-path" class="font-monospace small text-muted"></span>
                        </div>
                        <div id="sessions-root-dirs"></div>
                        <div class="mt-2 text-end">
                            <button type="button" id="sessions-root-select" class="btn btn-sm btn-primary">
                                <i class="fa fa-check me-1"></i>{{ 'settings.sessions_root.select'|trans }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# ============================================================
       SECTION : Notifications & Alertes
    ============================================================ #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-bell text-primary"></i>
                <h5 class="mb-0">{{ 'settings.notifications.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'notifications'}) }}">
                <div class="card-body">

                    {# Emails #}
                    <div class="mb-4">
                        <label class="form-label fw-medium">
                            <i class="fa fa-fw fa-envelope"></i>
                            {{ 'settings.notifications.emails'|trans }}
                        </label>
                        <textarea name="emails" class="form-control font-monospace" rows="3"
                                  placeholder="une@adresse.com&#10;autre@adresse.com">{{ notifications.emails|join('\n') }}</textarea>
                        <div class="form-text">{{ 'settings.notifications.emails_help'|trans }}</div>
                    </div>

                    <hr>

                    {# Seuils météo #}
                    <p class="fw-medium mb-3">
                        <i class="fa fa-fw fa-cloud"></i>
                        {{ 'settings.notifications.weather_thresholds'|trans }}
                    </p>

                    <div class="row g-3 mb-3">
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.cloud_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_cloud_max" class="form-control"
                                       value="{{ notifications.weather_cloud_max }}" min="0" max="100" step="5">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.wind_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_wind_max" class="form-control"
                                       value="{{ notifications.weather_wind_max }}" min="0" max="30" step="0.5">
                                <span class="input-group-text">m/s</span>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <label class="form-label small">{{ 'settings.notifications.precip_max'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="weather_precip_max" class="form-control"
                                       value="{{ notifications.weather_precip_max }}" min="0" max="10" step="0.1">
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    {# Seuils astronomiques #}
                    <p class="fw-medium mb-3">
                        <i class="fa fa-fw fa-moon"></i>
                        {{ 'settings.notifications.astro_thresholds'|trans }}
                    </p>

                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label small">{{ 'settings.notifications.min_useful_hours'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="min_useful_hours" class="form-control"
                                       value="{{ notifications.min_useful_hours }}" min="0" max="12" step="0.5">
                                <span class="input-group-text">h</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label small">{{ 'settings.notifications.min_moon_sep'|trans }}</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="min_moon_sep" class="form-control"
                                       value="{{ notifications.min_moon_sep }}" min="0" max="180" step="5">
                                <span class="input-group-text">°</span>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-footer text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# ============================================================
       SECTION : Filtres
    ============================================================ #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-filter text-primary"></i>
                <h5 class="mb-0">{{ 'settings.filters.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'filters'}) }}">
                <div class="card-body p-2">
                    <p class="text-muted small mb-2">{{ 'settings.filters.aliases_help'|trans }}</p>
                    <table id="filters-table" class="table table-sm align-middle mb-2">
                        <thead>
                            <tr>
                                <th style="width:44px">{{ 'settings.filters.color'|trans }}</th>
                                <th style="width:90px">{{ 'settings.filters.label'|trans }}</th>
                                <th style="width:80px">{{ 'settings.filters.band'|trans }}</th>
                                <th>{{ 'settings.filters.aliases'|trans }}</th>
                                <th style="width:36px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in filters %}
                            <tr>
                                <td><input type="color" name="filter_color[]" class="form-control form-control-color p-0 border-0" value="{{ f.color }}" style="width:36px;height:32px;cursor:pointer"></td>
                                <td><input name="filter_label[]" class="form-control form-control-sm" value="{{ f.label }}"></td>
                                <td>
                                    <select name="filter_band[]" class="form-select form-select-sm">
                                        <option value="BB" {% if (f.band|default('BB')) == 'BB' %}selected{% endif %}>BB</option>
                                        <option value="NB" {% if (f.band|default('BB')) == 'NB' %}selected{% endif %}>NB</option>
                                    </select>
                                </td>
                                <td><input name="filter_aliases[]" class="form-control form-control-sm" value="{{ f.aliases|join(', ') }}" placeholder="lum, luminance, …"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-filter-row">✕</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" id="add-filter-row" class="btn btn-sm btn-outline-secondary">
                        <i class="fa fa-plus me-1"></i>{{ 'settings.filters.add'|trans }}
                    </button>
                </div>
                <div class="card-footer text-end py-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# ============================================================
       SECTION : Session Folder Template
    ============================================================ #}
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="fa fa-fw fa-folder-tree text-primary"></i>
                <h5 class="mb-0">{{ 'settings.template.title'|trans }}</h5>
            </div>
            <form method="post" action="{{ path('settings_save_section', {section: 'session_template'}) }}">
                <div class="card-body">
                    <p class="text-muted small mb-2">{{ 'settings.template.help'|trans }}</p>

                    <div id="template-roles-status" class="alert alert-success py-1 px-2 small mb-3"></div>

                    <div id="template-editor"
                         data-roles='{{ roles|json_encode }}'
                         data-default-template='{{ template_tree|json_encode }}'
                         data-msg-valid="{{ 'settings.template.roles_valid'|trans }}"
                         data-msg-missing="{{ 'settings.template.roles_missing'|trans }}"
                         data-msg-duplicate="{{ 'settings.template.roles_duplicate'|trans }}"
                         data-msg-allow-extra="{{ 'settings.template.allow_extra'|trans }}">
                    </div>

                    <input type="hidden" name="session_template" id="template-json"
                           value='{{ template_tree|json_encode }}'>

                    <div class="mt-3 d-flex gap-2 align-items-center">
                        <button type="button" id="template-add-root" class="btn btn-sm btn-outline-secondary">
                            <i class="fa fa-plus me-1"></i>{{ 'settings.template.add_root'|trans }}
                        </button>
                        <button type="button" id="template-reset" class="btn btn-sm btn-outline-warning">
                            <i class="fa fa-rotate-left me-1"></i>{{ 'settings.template.reset'|trans }}
                        </button>
                    </div>

                    <hr class="my-3">

                    <div class="template-danger-zone">
                        <p class="small fw-medium mb-2">
                            <i class="fa fa-fw fa-triangle-exclamation text-danger"></i>
                            {{ 'settings.template.migrate_zone'|trans }}
                        </p>
                        <div class="d-flex gap-2">
                            <button type="button" id="template-dry-run" class="btn btn-sm btn-outline-info">
                                <i class="fa fa-eye me-1"></i>{{ 'settings.template.dry_run_btn'|trans }}
                            </button>
                            <button type="button" id="template-migrate" class="btn btn-sm btn-outline-danger">
                                <i class="fa fa-arrows-rotate me-1"></i>{{ 'settings.template.migrate_btn'|trans }}
                            </button>
                        </div>
                        <div id="template-dry-run-result" class="mt-2 d-none"></div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button type="submit" id="template-save-btn" class="btn btn-primary btn-sm">
                        <i class="fa fa-fw fa-save"></i> {{ 'settings.save'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

<script>
(function () {
    var input = document.getElementById('sessions-root-input');
    var browseBtn = document.getElementById('sessions-root-browse');
    var resetBtn = document.getElementById('sessions-root-reset');
    var browser = document.getElementById('sessions-root-browser');
    var dirsContainer = document.getElementById('sessions-root-dirs');
    var goUpBtn = document.getElementById('sessions-root-go-up');
    var selectBtn = document.getElementById('sessions-root-select');
    var currentPathSpan = document.getElementById('sessions-root-current-path');
    var browsePath = '';

    function loadDirs(path) {
        var url = '{{ path('api_browse_dirs') }}' + '?path=' + encodeURIComponent(path);
        fetch(url).then(function (r) { return r.json(); }).then(function (data) {
            if (data.error) { return; }
            browsePath = data.current;
            currentPathSpan.textContent = data.current;
            dirsContainer.innerHTML = '';
            if (data.dirs.length === 0) {
                dirsContainer.innerHTML = '<div class="text-muted small p-2">{{ 'settings.sessions_root.empty_dir'|trans }}</div>';
                return;
            }
            data.dirs.forEach(function (d) {
                var item = document.createElement('div');
                item.className = 'dir-browser-item';
                item.innerHTML = '<i class="fa fa-folder text-warning me-2"></i>' + d;
                item.addEventListener('click', function () { loadDirs(data.current + '/' + d); });
                dirsContainer.appendChild(item);
            });
        });
    }

    browseBtn.addEventListener('click', function () {
        browser.classList.toggle('d-none');
        if (!browser.classList.contains('d-none')) {
            loadDirs(input.value || '{{ sessions_root }}');
        }
    });

    goUpBtn.addEventListener('click', function () {
        if (browsePath) {
            var parent = browsePath.replace(/\/[^\/]+$/, '') || '/';
            loadDirs(parent);
        }
    });

    selectBtn.addEventListener('click', function () {
        input.value = browsePath;
        input.removeAttribute('readonly');
        browser.classList.add('d-none');
    });

    resetBtn.addEventListener('click', function () {
        input.value = '';
        input.removeAttribute('readonly');
    });
})();
</script>
<script>
(function () {
    const tmpl = `<tr>
  <td><input type="color" name="filter_color[]" class="form-control form-control-color p-0 border-0" value="#6c757d" style="width:36px;height:32px;cursor:pointer"></td>
  <td><input name="filter_label[]" class="form-control form-control-sm"></td>
  <td><select name="filter_band[]" class="form-select form-select-sm"><option value="BB" selected>BB</option><option value="NB">NB</option></select></td>
  <td><input name="filter_aliases[]" class="form-control form-control-sm" placeholder="lum, luminance, …"></td>
  <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-filter-row">✕</button></td>
</tr>`;
    document.getElementById('add-filter-row').addEventListener('click', () => {
        document.querySelector('#filters-table tbody').insertAdjacentHTML('beforeend', tmpl);
    });
    document.getElementById('filters-table').addEventListener('click', (e) => {
        if (e.target.classList.contains('js-remove-filter-row')) {
            e.target.closest('tr').remove();
        }
    });
})();
</script>
<script src="{{ asset('assets/js/session-template-editor.js') }}?v=2"></script>
<script>
(function () {
    var dryRunBtn = document.getElementById('template-dry-run');
    var migrateBtn = document.getElementById('template-migrate');
    var resultDiv = document.getElementById('template-dry-run-result');

    if (dryRunBtn) {
        dryRunBtn.addEventListener('click', function () {
            dryRunBtn.disabled = true;
            fetch('{{ path('settings_template_dry_run') }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    resultDiv.classList.remove('d-none');
                    if (data.total_moves === 0) {
                        resultDiv.className = 'mt-2 alert alert-info py-2 small';
                        resultDiv.textContent = 'No changes needed. All sessions match the current template.';
                    } else {
                        var html = '<strong>' + data.affected + ' session(s) affected, ' + data.total_moves + ' file move(s)</strong>';
                        html += '<ul class="mb-0 mt-1">';
                        data.details.forEach(function (d) {
                            html += '<li>' + d.session;
                            d.moves.forEach(function (m) {
                                html += '<br><small class="text-muted">' + m.role + ': ' + m.from + ' &rarr; ' + m.to + ' (' + m.files + ' files)</small>';
                            });
                            html += '</li>';
                        });
                        html += '</ul>';
                        resultDiv.className = 'mt-2 alert alert-warning py-2 small';
                        resultDiv.innerHTML = html;
                    }
                    dryRunBtn.disabled = false;
                })
                .catch(function () { dryRunBtn.disabled = false; });
        });
    }

    if (migrateBtn) {
        migrateBtn.addEventListener('click', function () {
            if (!confirm('{{ 'settings.template.migrate_confirm'|trans }}')) return;
            migrateBtn.disabled = true;
            fetch('{{ path('settings_template_migrate') }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.dispatched) {
                        resultDiv.classList.remove('d-none');
                        resultDiv.className = 'mt-2 alert alert-success py-2 small';
                        resultDiv.textContent = '{{ 'settings.template.migrate_dispatched'|trans }}';
                    }
                    migrateBtn.disabled = false;
                })
                .catch(function () { migrateBtn.disabled = false; });
        });
    }
})();
</script>

</div>
{% endblock %}

{% set pageTitle = target.name ~ " - " ~ session.startedAt|date("Y-m-d") %}
{% set hideBreadcrumb = true %}
{% extends 'base.html.twig' %}
{% block body %}
    <div id="fs-scan-container"
         data-scan-url="{{ path('api_scan_files', {sessionId: session.id}) }}"
         data-scan-apply-url="{{ path('api_scan_files_apply', {sessionId: session.id}) }}"
         data-scan-level="files"
         data-scan-trans="{{ {
             scanning: 'scan.scanning'|trans,
             changes_detected: 'scan.changes_detected_files'|trans,
             new_files: 'scan.new_files'|trans,
             apply_files: 'scan.apply_files'|trans,
             ignore: 'scan.ignore'|trans,
             refresh: 'scan.refresh'|trans,
             applying: 'scan.applying'|trans,
             applied_error: 'scan.applied_error'|trans,
         }|json_encode|e('html_attr') }}">
    </div>
    {% if consistency is defined and (consistency.missing|length > 0 or consistency.unexpected|length > 0) %}
    <div class="alert alert-warning py-2 mb-3 small">
        <i class="fa fa-triangle-exclamation me-1"></i>
        <strong>{{ 'session.consistency_warning'|trans }}</strong>
        {% if consistency.missing|length > 0 %}
            <br>{{ 'session.missing_folder'|trans }}: <code>{{ consistency.missing|join('</code>, <code>') }}</code>
        {% endif %}
        {% if consistency.unexpected|length > 0 %}
            <br>{{ 'session.unexpected_folder'|trans }}: <code>{{ consistency.unexpected|join('</code>, <code>') }}</code>
        {% endif %}
    </div>
    {% endif %}
    {% set lights = session.exposures|filter(e => e.type == "LIGHT") %}

    {# ############## MODAL - EDIT ############## #}
    {% form_theme editForm 'bootstrap_4_layout.html.twig' %}
    <div aria-hidden="true" aria-labelledby="editModalLabel" class="modal fade"
         id="editModal"
         tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" id="staticBackdrop">
            <div class="modal-content ">
                {{ form_start(editForm) }}
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="editModalLabel1">{{ 'session.btn_edit'|trans }}</h1>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3 app-form" id="newtask">
                            {{ form_widget(editForm) }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" id="push"
                                type="submit">{{ 'session.btn_update'|trans }}
                        </button>
                    </div>
                {{ form_end(editForm) }}
            </div>
        </div>
    </div>

    {# ############## HERO CARD ############## #}
    {# ── Precompute stats ── #}
    {% set filters = [] %}
    {% set hasFilters = false %}
    {% set totalIntegrationS = 0 %}
    {% set durations = [] %}
    {% for e in lights %}
        {% set totalIntegrationS = totalIntegrationS + e.exposureS %}
        {% if e.exposureS not in durations %}
            {% set durations = durations|merge([e.exposureS]) %}
        {% endif %}
        {% if e.filterName not in filters %}
            {% set filters = filters|merge([e.filterName]) %}
            {% if e.filterName is not null %}
                {% set hasFilters = true %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if hasFilters %}
        {% set filterOrder = ['L','R','G','B','S','H','O'] %}
        {% set filtersSorted = [] %}
        {% for letter in filterOrder %}
            {% for f in filters %}
                {% if f|first|upper == letter %}
                    {% set filtersSorted = filtersSorted|merge([f]) %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% for f in filters %}
            {% if f|first|upper not in filterOrder %}
                {% set filtersSorted = filtersSorted|merge([f]) %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {% set totalH = (totalIntegrationS / 3600)|round(0, 'floor') %}
    {% set totalM = ((totalIntegrationS % 3600) / 60)|round(0, 'floor') %}
    {% set masters_list = session.masters %}
    {% set exports_list = session.exports %}

    {# Compute distinct observation nights from LIGHT exposures.
       Use "astronomical night" grouping: subtract 12h so that images after midnight
       belong to the previous evening's date. #}
    {% set nightDates = [] %}
    {% for e in lights %}
        {% if e.dateTaken %}
            {% set d = e.dateTaken|date_modify("-12 hours")|date("Y-m-d") %}
            {% if d not in nightDates %}
                {% set nightDates = nightDates|merge([d]) %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% set nightDates = nightDates|sort %}

    <div class="card mb-3" id="session-hero">
        <div class="card-header d-flex align-items-center py-2 px-3">
            <h5 class="mb-0 f-w-600">{{ pageTitle }}</h5>
            <div class="input-group input-group-sm ms-auto" style="width: auto">
                {% if target.ra != "" %}
                    <a href="{{ target.telescopiusUrl }}" target="_blank"
                       class="btn btn-primary icon-btn b-r-left" title="Telescopius">
                        <i class="fa primary fa-crosshairs"></i>
                    </a>
                {% endif %}
                {% if session.astrobin != "" %}
                    <a href="{{ session.astrobin }}" target="_blank"
                       class="btn btn-primary icon-btn{{ target.ra == '' ? ' b-r-left' : '' }}" title="Astrobin">
                        <i class="fa primary fa-star"></i>
                    </a>
                {% endif %}
                <button class="btn btn-primary icon-btn" id="btn-toggle-hero" title="Toggle hero">
                    <i class="ti ti-layout-sidebar-left-collapse"></i>
                </button>
                <button class="btn btn-primary icon-btn" data-bs-target="#editModal"
                        data-bs-toggle="modal"
                        type="button"><i class="ti ti-edit"></i>
                </button>
                <a href="openfolder:{{ session.path|default('') }}"
                   class="btn btn-primary icon-btn js-openfolder">
                    <i class="fa primary fa-folder-open"></i>
                </a>
                <button type="button" onclick="openRefreshModal({{ session.id }})"
                        title="{{ 'session.refresh.title'|trans }}"
                        class="btn btn-primary icon-btn">
                    <i class="fa primary fa-refresh"></i>
                </button>
                <form method="post" action="{{ path('delete_session', {'id': session.id}) }}" style="display:inline" onsubmit="return confirm('{{ 'session.confirm_delete'|trans }}')">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete_session_' ~ session.id) }}">
                    <button type="submit" class="btn btn-outline-primary icon-btn b-r-right" title="Delete session">
                        <i class="fa primary fa-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body py-3">
            <div class="row g-4">
                {# ── Col 1 : Identity ── #}
                <div class="col-lg-3 d-flex flex-column hero-identity">
                    <div class="d-flex align-items-center mb-3">
                        <ul class="avatar-group breadcrumb-start mb-0 me-3">
                            {% for author in session.authors %}
                                <li class="h-35 w-35 d-flex-center b-r-50 position-relative" data-bs-title="{{ author.name }}" data-bs-toggle="tooltip">
                                    <img alt="{{ author.name }}" class="img-fluid b-r-50 overflow-hidden" src="{{ author.logo }}">
                                </li>
                            {% endfor %}
                        </ul>
                        <div>
                            <div class="f-w-600 f-s-16">
                                {% if nightDates|length > 1 %}
                                    {{ nightDates|first }} → {{ nightDates|last }}
                                    <span class="text-muted" style="font-size:.7rem">({{ nightDates|length }} {{ 'session.nights'|trans }})</span>
                                {% else %}
                                    {{ session.startedAt|date("F jS Y") }}
                                {% endif %}
                            </div>
                            {% if session.setup %}
                                <div class="text-secondary f-s-13"><i class="fa fa-fw fa-binoculars"></i> {{ session.setup.name }}</div>
                            {% endif %}
                            {% if session.observatory %}
                                <div class="text-secondary f-s-13"><i class="fa fa-fw fa-map-marker-alt"></i> {{ session.observatory.name }}</div>
                            {% endif %}
                        </div>
                    </div>

                    {# Astrobin stats (inline) #}
                    {% if session.astrobin != "" %}
                    <div class="hero-astrobin-inline mb-2">
                        <i class="fa fa-fw fa-eye"></i> {{ session.astrobinViews }}
                        <i class="fa fa-fw fa-heart ms-2"></i> {{ session.astrobinLikes }}
                        {% if session.astrobinBookmarks > 0 %}
                            <i class="fa fa-fw fa-bookmark ms-2"></i> {{ session.astrobinBookmarks }}
                        {% endif %}
                        {% if session.astrobinComments > 0 %}
                            <i class="fa fa-fw fa-comment ms-2"></i> {{ session.astrobinComments }}
                        {% endif %}
                    </div>
                    {% endif %}

                    {# Notes (collapsible) #}
                    <div class="mt-auto">
                        <div class="d-flex align-items-center mb-1">
                            <a class="text-decoration-none small fw-semibold" data-bs-toggle="collapse" href="#hero-notes-collapse" role="button" aria-expanded="false">
                                <i class="fa fa-fw fa-sticky-note me-1"></i>{{ 'session.notes_title'|trans }}
                                <i class="ti ti-chevron-down ms-1" style="font-size: .7rem"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-secondary p-0 px-1 ms-2" data-bs-toggle="modal" data-bs-target="#notesModal" title="{{ 'session.notes_title'|trans }}">
                                <i class="ti ti-edit" style="font-size: .7rem"></i>
                            </button>
                        </div>
                        <div class="collapse hero-notes-body" id="hero-notes-collapse">
                            {% if session.notes %}
                                <div id="notes-viewer"></div>
                            {% else %}
                                <p class="text-muted fst-italic small mb-0" id="notes-empty-msg">{{ 'session.notes_placeholder'|trans }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# ── Col 2 : Stats ── #}
                <div class="col-lg-5">
                    <div class="hero-stats-grid">
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ lights|length }}</div>
                            <div class="hero-stat-label">{{ 'session.stat_lights'|trans }}</div>
                        </div>
                        {% if hasFilters %}
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ filtersSorted|default(["N/A"])|map(f => f|first)|join('') }}</div>
                            <div class="hero-stat-label">{{ 'session.stat_filters'|trans }}</div>
                        </div>
                        {% endif %}
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ durations|default(["??"])|join('/',) }}s</div>
                            <div class="hero-stat-label">{{ 'session.stat_duration'|trans }}</div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ totalH > 0 ? totalH ~ 'h' : '' }}{{ totalM }}m</div>
                            <div class="hero-stat-label">{{ 'session.stat_integration'|trans }}</div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ masters_list|length }}</div>
                            <div class="hero-stat-label">{{ 'session.stat_masters'|trans }}</div>
                        </div>
                        {% if exports_list|length > 0 %}
                        <div class="hero-stat">
                            <div class="hero-stat-value">{{ exports_list|length }}</div>
                            <div class="hero-stat-label">{{ 'session.stat_exports'|trans }}</div>
                        </div>
                        {% endif %}
                    </div>

                    {# ── Phase tabs (inside hero) ── #}
                    {% set hasAcquisition = (exposures|length > 0) or (session.phd2Calibrations|length > 0) or (session.phd2Guidings|length > 0) or (session.autofocusLogs|length > 0) %}
                    {% set hasTraitement = (session.wbppLogs|length > 0) or (masters|length > 0) or (exports|length > 0) %}
                    <div class="hero-stats-grid mt-2" id="session-phase-tabs" role="tablist">
                        <button class="btn btn-sm btn-outline-primary phase-tab-btn" data-bs-target="#phase-planification" data-bs-toggle="tab" role="tab" type="button" id="phase-planification-tab">
                            <i class="fa fa-fw fa-cloud-moon me-1"></i>{{ 'session.phase_planification'|trans }}
                        </button>
                        {% if hasAcquisition %}
                        <button class="btn btn-sm btn-outline-primary phase-tab-btn active" data-bs-target="#phase-acquisition" data-bs-toggle="tab" role="tab" type="button" id="phase-acquisition-tab">
                            <i class="fa fa-fw fa-camera me-1"></i>{{ 'session.phase_acquisition'|trans }}
                        </button>
                        {% endif %}
                        {% if hasTraitement %}
                        <button class="btn btn-sm btn-outline-primary phase-tab-btn" data-bs-target="#phase-traitement" data-bs-toggle="tab" role="tab" type="button" id="phase-traitement-tab">
                            <i class="fa fa-fw fa-gears me-1"></i>{{ 'session.phase_traitement'|trans }}
                        </button>
                        {% endif %}
                    </div>

                    {# ── Sub-tabs for Acquisition (visible when Acquisition phase is active) ── #}
                    {% if hasAcquisition %}
                    {% set acqLights = session.exposures|filter(e => e.type == "LIGHT") %}
                    {% set acqDofs = session.exposures|filter(e => e.type != "LIGHT") %}
                    {% set acqHasPhd2 = (session.phd2Calibrations|length > 0) or (session.phd2Guidings|length > 0) %}
                    {% set acqHasAutofocus = session.autofocusLogs|length > 0 %}
                    <div class="d-flex flex-wrap gap-1 mt-2 phase-sub-tab-row justify-content-center" id="acq-sub-tabs-hero">
                        {% if acqLights|length %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn active" data-sub-target="#acq-lights-pane" data-sub-content="#acq-sub-content" type="button">
                            {{ 'session.tab_lights'|trans }} <span class="badge bg-secondary ms-1">{{ acqLights|length }}</span>
                        </button>
                        {% endif %}
                        {% if acqDofs|length %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn{{ acqLights|length == 0 ? ' active' : '' }}" data-sub-target="#acq-dofs-pane" data-sub-content="#acq-sub-content" type="button">
                            {{ 'session.tab_dofs'|trans }} <span class="badge bg-secondary ms-1">{{ acqDofs|length }}</span>
                        </button>
                        {% endif %}
                        {% if acqHasPhd2 %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn" data-sub-target="#acq-phd2-pane" data-sub-content="#acq-sub-content" type="button">
                            PHD2 <span class="badge bg-secondary ms-1">{{ session.phd2Calibrations|length + session.phd2Guidings|length }}</span>
                        </button>
                        {% endif %}
                        {% if acqHasAutofocus %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn" data-sub-target="#acq-autofocus-pane" data-sub-content="#acq-sub-content" type="button">
                            AutoFocus <span class="badge bg-secondary ms-1">{{ session.autofocusLogs|length }}</span>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# ── Sub-tabs for Traitement (hidden until Traitement phase is active) ── #}
                    {% if hasTraitement %}
                    {% set procHasWbpp = session.wbppLogs|length > 0 %}
                    {% set procHasMasters = masters|length > 0 %}
                    {% set procHasExports = exports|length > 0 %}
                    <div class="d-flex flex-wrap gap-1 mt-2 phase-sub-tab-row justify-content-end d-none" id="proc-sub-tabs-hero">
                        {% if procHasWbpp %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn active" data-sub-target="#proc-wbpp-pane" data-sub-content="#proc-sub-content" type="button">
                            WBPP <span class="badge bg-secondary ms-1">{{ session.wbppLogs|length }}</span>
                        </button>
                        {% endif %}
                        {% if procHasMasters %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn{{ not procHasWbpp ? ' active' : '' }}" data-sub-target="#proc-masters-pane" data-sub-content="#proc-sub-content" type="button">
                            {{ 'session.tab_masters'|trans }} <span class="badge bg-secondary ms-1">{{ masters|length }}</span>
                        </button>
                        {% endif %}
                        {% if procHasExports %}
                        <button class="btn btn-sm btn-outline-primary phase-sub-btn{{ not procHasWbpp and not procHasMasters ? ' active' : '' }}" data-sub-target="#proc-exports-pane" data-sub-content="#proc-sub-content" type="button">
                            {{ 'session.tab_exports'|trans }} <span class="badge bg-secondary ms-1">{{ exports|length }}</span>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                {# ── Col 3 : Donut chart ── #}
                <div class="col-lg-4 d-flex align-items-center justify-content-center">
                    {% include 'browse/session/filters_repartition.html.twig' %}
                </div>
            </div>
        </div>
    </div>

    {# ############## PHASE CONTENT ############## #}
    <div class="tab-content phase-content" id="session-phase-content">
        {# ── Planification ── #}
        <div class="tab-pane fade" id="phase-planification" role="tabpanel">
            {% include 'browse/session/phase_planification.html.twig' %}
        </div>

        {# ── Acquisition ── #}
        {% if hasAcquisition %}
        <div class="tab-pane fade show active" id="phase-acquisition" role="tabpanel">
            {% include 'browse/session/phase_acquisition.html.twig' %}
        </div>
        {% endif %}

        {# ── Traitement ── #}
        {% if hasTraitement %}
        <div class="tab-pane fade" id="phase-traitement" role="tabpanel">
            {% include 'browse/session/phase_traitement.html.twig' %}
        </div>
        {% endif %}
    </div>

    {# ############## NOTES MODAL ############## #}
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">
                        <i class="fa fa-fw fa-sticky-note me-1"></i>{{ 'session.notes_title'|trans }}
                    </h5>
                    <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body p-2">
                    <div id="notes-editor-el"></div>
                </div>
                <div class="modal-footer">
                    <span id="notes-save-spinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    <button id="notes-save-btn" class="btn btn-primary">{{ 'session.notes_save'|trans }}</button>
                </div>
            </div>
        </div>
    </div>

    {# ############## REFRESH MODAL ############## #}
    <div class="modal fade" id="refreshModal" tabindex="-1" aria-labelledby="refreshModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refreshModalLabel">
                        <i class="fa fa-refresh me-1"></i>{{ 'session.refresh.title'|trans }}
                    </h5>
                    <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body" id="refreshModalBody"></div>
                <div class="modal-footer" id="refreshModalFooter"></div>
            </div>
        </div>
    </div>

{% endblock %}

{% block page_scripts %}
    <link type="text/css" rel="stylesheet" href="{{ asset('js9/js9support.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ asset('js9/js9.css') }}">
    <script>var JS9Prefs = {
        "globalOpts": { "helperType": "none" },
        "imageOpts":  { "colormap": "grey", "scale": "log" }
    }</script>
    <script type="text/javascript" src="{{ asset('js9/js9support.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js9/js9.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js9/js9plugins.min.js') }}"></script>

    <script src="https://unpkg.com/astronomy-engine/astronomy.browser.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        if (window.ChartZoom) {
            Chart.register(window.ChartZoom);
        } else {
            console.error('chartjs-plugin-zoom failed to load (no window.ChartZoom).');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>

    <script src="{{ asset('assets/js/astronomy-helpers.js') }}"></script>
    <script src="{{ asset('assets/js/altitude-chart.js') }}?v=2"></script>

    <script>
    // Toggle hero card
    $('#btn-toggle-hero').on('click', function () {
        var $hero = $('#session-hero');
        var isCollapsed = $hero.hasClass('d-none');
        if (isCollapsed) {
            $hero.removeClass('d-none');
            $(this).find('i').removeClass('ti-layout-sidebar-left-expand').addClass('ti-layout-sidebar-left-collapse');
        } else {
            $hero.addClass('d-none');
            $(this).find('i').removeClass('ti-layout-sidebar-left-collapse').addClass('ti-layout-sidebar-left-expand');
        }
    });

    // Toggle details column in preview cards
    $(document).on('click', '.btn-toggle-details', function () {
        var $btn = $(this);
        var $detailsCol = $($btn.data('details'));
        var $previewCol = $btn.closest('[id$="-preview-col"]');
        var isCollapsed = $detailsCol.hasClass('d-none');
        if (isCollapsed) {
            $detailsCol.removeClass('d-none');
            $previewCol.removeClass('col-xxl-12').addClass('col-xxl-9');
            $btn.find('i').removeClass('ti-layout-sidebar-right-expand').addClass('ti-layout-sidebar-right-collapse');
        } else {
            $detailsCol.addClass('d-none');
            $previewCol.removeClass('col-xxl-9').addClass('col-xxl-12');
            $btn.find('i').removeClass('ti-layout-sidebar-right-collapse').addClass('ti-layout-sidebar-right-expand');
        }
    });
    </script>

    {# ── Phase tab persistence + Chart.js resize ── #}
    <script>
    var PHASE_KEY = 'session-active-phase';

    // Sub-tab rows mapping: phase target → sub-tab row id
    var subTabMap = {
        '#phase-acquisition': 'acq-sub-tabs-hero',
        '#phase-traitement': 'proc-sub-tabs-hero'
    };

    function syncSubTabs(phaseTarget) {
        Object.keys(subTabMap).forEach(function(key) {
            var el = document.getElementById(subTabMap[key]);
            if (!el) return;
            if (key === phaseTarget) {
                el.classList.remove('d-none');
            } else {
                el.classList.add('d-none');
            }
        });
    }

    var savedPhase = localStorage.getItem(PHASE_KEY);
    if (savedPhase) {
        var phaseTab = document.querySelector('#session-phase-tabs button[data-bs-target="' + savedPhase + '"]');
        if (phaseTab) new bootstrap.Tab(phaseTab).show();
        syncSubTabs(savedPhase);
    } else {
        // Default: show acquisition sub-tabs if present
        syncSubTabs('#phase-acquisition');
    }

    document.querySelectorAll('#session-phase-tabs button').forEach(function(btn) {
        btn.addEventListener('shown.bs.tab', function() {
            var target = btn.getAttribute('data-bs-target');
            localStorage.setItem(PHASE_KEY, target);
            syncSubTabs(target);
            // Resize charts in newly visible tab
            if (typeof Chart !== 'undefined') {
                Chart.helpers.each(Chart.instances, function(c) { c.resize(); });
            }
        });
    });

    // Manual sub-tab switching (buttons are in hero, panes are in phase content)
    document.querySelectorAll('.phase-sub-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var targetPane = btn.getAttribute('data-sub-target');
            var contentId = btn.getAttribute('data-sub-content');
            var container = document.querySelector(contentId);
            if (!container) return;

            // Deactivate sibling buttons
            btn.parentElement.querySelectorAll('.phase-sub-btn').forEach(function(b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            // Hide all panes in this content, show the target
            container.querySelectorAll(':scope > .tab-pane').forEach(function(pane) {
                pane.classList.remove('show', 'active');
            });
            var target = document.querySelector(targetPane);
            if (target) {
                target.classList.add('show', 'active');
            }

            // Resize charts after tab switch
            if (typeof Chart !== 'undefined') {
                setTimeout(function() {
                    Chart.helpers.each(Chart.instances, function(c) { c.resize(); });
                }, 50);
            }
        });
    });
    </script>

    {# ── Altitude chart init (deferred — may be in hidden tab) ── #}
    {% if target.ra != "" %}
    <script>
    var altChartInitDone = false;
    var altChartCfg = {
        canvasId: 'altChart',
        metaId:   'meta',
        name:     '{{ target.name|e('js') }}',
        raH:      {{ target.ra }},
        decD:     {{ target.dec }},
        lat:      {{ session.observatory.lat }},
        lon:      {{ session.observatory.lon }},
        dateStr:  '{{ nightDates|first|default(session.startedAt|date("Y-m-d")) }}'
    };
    function initAltChartIfNeeded() {
        if (altChartInitDone) return;
        var canvas = document.getElementById('altChart');
        if (!canvas || canvas.offsetWidth === 0) return;
        altChartInitDone = true;
        initAltitudeChart(altChartCfg);
    }
    function reloadAltChart(dateStr) {
        altChartCfg.dateStr = dateStr;
        altChartInitDone = false;
        initAltitudeChart(altChartCfg);
    }
    // Try immediately (in case Planification is active tab)
    document.addEventListener('DOMContentLoaded', function() {
        initAltChartIfNeeded();
        var transitSel = document.getElementById('transitDaySelector');
        if (transitSel) {
            transitSel.addEventListener('change', function() {
                reloadAltChart(transitSel.value);
            });
        }
    });
    // Retry on tab show
    document.querySelectorAll('#session-phase-tabs button').forEach(function(btn) {
        btn.addEventListener('shown.bs.tab', function() {
            setTimeout(initAltChartIfNeeded, 50);
        });
    });
    </script>
    {% endif %}

    {# ---- Toast UI Editor (Notes) ---- #}
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.css">
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script>
    const NOTES_CONFIG = {
        currentNotes: {{ session.notes|default('')|json_encode|raw }},
        saveUrl:      '{{ path('session_notes', {id: session.id}) }}',
        theme:        '{{ appConfig.theme }}',
        trans: { placeholder: '{{ 'session.notes_placeholder'|trans|e('js') }}' }
    };
    </script>
    <script src="{{ asset('assets/js/notes-editor.js') }}"></script>
    <script src="{{ asset('assets/js/fs-scan.js') }}"></script>

    <script>
    window.REFRESH_CONFIG = {
        sessionId: {{ session.id }},
        trans: {
            counting:     '{{ 'session.refresh.counting'|trans|e('js') }}',
            total_files:  '{{ 'session.refresh.total_files'|trans|e('js') }}',
            confirm_text: '{{ 'session.refresh.confirm_text'|trans|e('js') }}',
            no_files:     '{{ 'session.refresh.no_files'|trans|e('js') }}',
            step_purge:   '{{ 'session.refresh.step.purge'|trans|e('js') }}',
            step_raws:    '{{ 'session.refresh.step.raws'|trans|e('js') }}',
            step_phd2:    '{{ 'session.refresh.step.phd2'|trans|e('js') }}',
            step_wbpp:    '{{ 'session.refresh.step.wbpp'|trans|e('js') }}',
            step_autofocus: '{{ 'session.refresh.step.autofocus'|trans|e('js') }}',
            step_masters: '{{ 'session.refresh.step.masters'|trans|e('js') }}',
            step_exports: '{{ 'session.refresh.step.exports'|trans|e('js') }}',
            processing:   '{{ 'session.refresh.processing'|trans|e('js') }}',
            done:         '{{ 'session.refresh.done'|trans|e('js') }}',
            files:        '{{ 'session.refresh.files'|trans|e('js') }}',
            complete:     '{{ 'session.refresh.complete'|trans|e('js') }}',
            btn_start:    '{{ 'session.refresh.btn_start'|trans|e('js') }}',
            btn_close:    '{{ 'session.refresh.btn_close'|trans|e('js') }}',
            btn_close_text: '{{ 'btn.close'|trans|e('js') }}',
            btn_cancel:   '{{ 'btn.cancel'|trans|e('js') }}',
            error:        '{{ 'session.refresh.error'|trans|e('js') }}',
            errors:       '{{ 'session.refresh.errors'|trans|e('js') }}',
            error_details:'{{ 'session.refresh.error_details'|trans|e('js') }}'
        }
    };
    </script>
    <script src="{{ asset('assets/js/session-refresh.js') }}"></script>

{% endblock %}
